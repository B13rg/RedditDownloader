<!DOCTYPE html>
<html lang="en">
<style>
	html{
		font-family: 'Helvetica', 'Arial', sans-serif;
	}

	.event-log {
		margin-bottom: 10px;
		border: 1px solid gray;
	}
</style>
<head>
	<meta charset="UTF-8">
	<title>Websocket Test Platform</title>
</head>
<body>

<div style="height: 800px;">
	<div class="container" style="display: flex; height: 100px;">
		<div id="log" style="width: 50%; background: #80d080; height: 750px; overflow: auto;">
		</div>
		<div style="flex-grow: 1; background: #8686e9; height: 750px; overflow: auto;">
			<pre id="state"></pre>
		</div>
	</div>
</div>

<div>
	<button onclick="stageGroup()">SourceGroup</button>
	<button onclick="stageSavedSource()">Source: [Saved Posts]</button>
	<button onclick="stageUpvotedSource()">Source: [Upvoted Posts]</button>
	<button onclick="stageSetting()">Update Setting</button>
	<button onclick="stageDLStart()">Start Download</button>
</div>
<textarea id="input" style="width: 400px; height: 200px;" autofocus></textarea> <br>

<button onclick="send()">Send</button>


</body>
<script>
	const input = document.getElementById('input');
	const output = document.getElementById('log');
	const stateLog = document.getElementById('state');
	const sock = new WebSocket("ws://localhost:7001");
	let uid = 0;
	let state = {};
	let logRows = [];
	let totalBytesRec = 0;

	document.body.style.backgroundColor = '#d98585';

	sock.onopen = (_event) => {
		console.log('Opened connection.');
		document.body.style.backgroundColor = '#FFFFFF';
	};

	sock.onclose = () => {
		console.error('Connection closed.');
		document.body.style.backgroundColor = '#d98585';
		setTimeout(()=> window.location.reload(), 5000);
	};

	sock.onmessage = function(event) {
		const packet = JSON.parse(event.data);
		const data = packet.data;

		totalBytesRec += event.data.length + 2;

		window.debugPacketCount = (window.debugPacketCount || 0) + 1;

		if (packet.type === 'ping') {
			sock.send('pong');
		} else if (packet.type === 'fullState') {
			state = data;
			stateLog.innerText = JSON.stringify(state, null, 4);
		} else if (packet.type === 'sc') {
			updateState(packet, data);
			stateLog.innerText = JSON.stringify(state, null, 4);
		} else {
			const row = document.createElement('pre');
			row.className = 'event-log';
			row.style.color = packet.error ? 'red' : 'black';
			row.innerText = new Date().toLocaleTimeString() + ': ' + JSON.stringify(packet, null, 2);
			output.appendChild(row);
			output.scrollTop = output.scrollHeight;
			console.debug("Received:", packet);
			logRows.push(row);

			while (logRows.length > 20) {
				logRows.splice(0, 1).forEach(r => output.removeChild(r));
			}
		}
	};

	function updateState(packet, data) {
		let cs = state;
		const path = data.path;
		const endKey = path.pop();

		path.forEach((p) => {
			if (!cs[p]) {
				if (data.deleted) return;
				cs[p] = {};
			}
			cs = cs[p];
		});

		if (data.deleted) {
			return delete cs[endKey];
		}
		cs[endKey] = data.value;
	}


	function send() {
		sock.send(input.value);
		input.value = '';
	}

	function stageMsg(type, obj) {
		const snd = {
			type,
			uid: ++uid,
			data: {
				...obj
			}
		}
		input.value = JSON.stringify(snd, null, 2);
	}

	function stageGroup() {
		stageMsg('updateObject', {
			dbType: 'DBSourceGroup',
			id: 1,
			newValues: {
				name: 'test',
				color: '#57a481'
			}
		})
	}

	function stageSavedSource() {
		stageMsg('updateObject', {
			dbType: 'DBSource',
			id: 1,
			newValues: {
				type: 'saved-posts',
				name: 'test-saved-group',
				dataJSON: JSON.stringify({
					getComments: true
				})
			},
			parents: [
				{
					dbType: 'DBSourceGroup',
					id: 1,
					property: 'sourceGroup'
				}
			]
		})
	}

	function stageUpvotedSource() {
		stageMsg('updateObject', {
			dbType: 'DBSource',
			id: 2,
			newValues: {
				type: 'upvoted-posts',
				name: 'test-upvoted-group',
				dataJSON: JSON.stringify({
					limit: 0
				})
			},
			parents: [
				{
					dbType: 'DBSourceGroup',
					id: 1,
					property: 'sourceGroup'
				}
			]
		})
	}

	function stageSetting() {
		stageMsg('saveSetting', {
			id: 1,
			key: 'refreshToken',
			value: ''
		})
	}

	function stageDLStart() {
		stageMsg('startDownload', {})
	}

	function formatBytes(bytes, decimals = 2) {
		if (bytes === 0) return '0 Bytes';

		const k = 1024;
		const dm = decimals < 0 ? 0 : decimals;
		const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];

		const i = Math.floor(Math.log(bytes) / Math.log(k));

		return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
	}

	setInterval(() => {
		console.log('Messages:', window.debugPacketCount, ' -> Size:', formatBytes(totalBytesRec));
	}, 10000)
</script>

</html>
